# Use Node.js 20 with Alpine Linux for smaller image
FROM node:20-alpine

# Install PostgreSQL and supervisor
RUN apk update && \
    apk add --no-cache \
    postgresql \
    postgresql-contrib \
    supervisor \
    bash

# Create directories
RUN mkdir -p /var/lib/postgresql/data /var/run/postgresql /app/backend

# Set PostgreSQL user
RUN chown -R postgres:postgres /var/lib/postgresql/data /var/run/postgresql

# Initialize PostgreSQL database
USER postgres
RUN initdb -D /var/lib/postgresql/data

# Configure PostgreSQL
RUN echo "host all all 0.0.0.0/0 md5" >> /var/lib/postgresql/data/pg_hba.conf && \
    echo "listen_addresses='*'" >> /var/lib/postgresql/data/postgresql.conf

# Switch back to root
USER root

# Copy backend files
WORKDIR /app/backend
COPY backend/package*.json ./
RUN npm ci --only=production

COPY backend/ .
RUN npm run build

# Copy database initialization script
COPY backend/init-db.sql /docker-entrypoint-initdb.d/

# Create startup script
RUN cat > /startup.sh << 'EOF'
#!/bin/bash
set -e

if [ -z "${DATABASE_URL}" ]; then
    echo "âŒ DATABASE_URL is not set. Please configure a managed PostgreSQL instance."
    exit 1
fi

# Ensure defaults but do not override provided values
export NODE_ENV="${NODE_ENV:-production}"
export PORT="${PORT:-5001}"

# Start Node.js backend
cd /app/backend
exec node dist/index.js
EOF

RUN chmod +x /startup.sh

# Supervisor configuration
RUN cat > /etc/supervisor/conf.d/supervisord.conf << 'EOF'
[supervisord]
nodaemon=true
user=root

[program:startup]
command=/startup.sh
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
EOF

# Expose port
EXPOSE 5001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD node -e "require('http').get('http://localhost:5001/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"

# Start supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
