<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <title>AI Personal Color Analysis for Hijab - Noor</title>
    
    <!-- DNS Prefetch for faster connections -->
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    
    <!-- Preconnect to critical domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Preload critical font -->
    <link rel="preload" href="https://fonts.gstatic.com/s/plusjakartasans/v8/LDIoaomQNQcsA88c7O9yZ4KMCoOg4Ko20SAlxw.woff2" as="font" type="font/woff2" crossorigin />
    
    <!-- Load fonts with display swap for better performance -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    
    <!-- Basic polyfills for older browsers -->
    <script>
      // Check if browser supports basic features
      if (!window.Promise || !window.fetch || !window.Symbol) {
        document.write('<script src="https://polyfill.io/v3/polyfill.min.js?features=Promise,fetch,Symbol,Object.assign,Array.from"><\/script>');
      }
      
      // Global error handler for chunk loading failures
      window.addEventListener('error', function(e) {
        if (e.filename && (e.filename.includes('.js') || e.filename.includes('.css'))) {
          console.error('Resource loading error:', e.filename);
          
          // Check if this is a chunk loading error
          const isChunkError = e.message && (
            e.message.includes('Loading chunk') ||
            e.message.includes('Failed to fetch dynamically imported module')
          );
          
          if (isChunkError) {
            // Increment error count
            const errorCount = parseInt(sessionStorage.getItem('chunk_error_count') || '0');
            sessionStorage.setItem('chunk_error_count', (errorCount + 1).toString());
            
            // Auto-reload on first error to try to recover
            if (errorCount === 0) {
              console.log('Auto-reloading due to chunk error...');
              setTimeout(() => {
                window.location.reload();
              }, 100);
            } else if (errorCount < 3) {
              // Show user message after multiple failures
              if (confirm('Some resources failed to load. Would you like to refresh the page?')) {
                sessionStorage.removeItem('chunk_error_count');
                window.location.reload();
              }
            }
          }
        }
      }, true);
      
      // Clear error count on successful page load
      window.addEventListener('load', function() {
        sessionStorage.removeItem('chunk_error_count');
        
        // Force unregister old service workers if cache version changes
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function(registrations) {
            const currentVersion = 'v2-2025-01-13';
            const storedVersion = localStorage.getItem('sw_version');
            
            if (storedVersion !== currentVersion) {
              console.log('Service worker version changed, clearing cache...');
              registrations.forEach(function(registration) {
                registration.unregister();
              });
              
              // Clear all caches
              if ('caches' in window) {
                caches.keys().then(function(names) {
                  names.forEach(function(name) {
                    caches.delete(name);
                  });
                });
              }
              
              localStorage.setItem('sw_version', currentVersion);
              
              // Reload after cache clear
              setTimeout(function() {
                window.location.reload(true);
              }, 100);
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Google Analytics 4 - Load after app to avoid blocking -->
    <script>
      // Defer GA4 loading to avoid blocking initial render
      window.addEventListener('load', function() {
        setTimeout(function() {
          // Load GA4 script
          const script = document.createElement('script');
          script.async = true;
          script.src = 'https://www.googletagmanager.com/gtag/js?id=G-JXPF7BL260';
          document.head.appendChild(script);
          
          // Initialize GA4 after script loads
          script.onload = function() {
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            
            const isDevMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const ga4Config = {
              send_page_view: false,
              allow_google_signals: true,
              allow_ad_personalization_signals: true,
              cookie_flags: 'SameSite=None;Secure'
            };
            
            if (isDevMode) {
              ga4Config.debug_mode = true;
            }
            
            gtag('config', 'G-JXPF7BL260', ga4Config);
          };
        }, 1000); // Delay GA4 by 1 second after page load
      });
    </script>
  </body>
</html>
